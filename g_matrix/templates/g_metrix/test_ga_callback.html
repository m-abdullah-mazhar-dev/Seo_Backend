<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Google Analytics OAuth Test</title>
</head>
<body>
  <h2>Testing Google Analytics OAuth Flow</h2>
  <p id="status">Waiting for code...</p>

  <script>
    const statusEl = document.getElementById("status");

    // 1. Debug log full query string
    console.log("Full query string:", window.location.search);

    // 2. Extract ?code= from URL
    const urlParams = new URLSearchParams(window.location.search);
    let code = urlParams.get("code");

    // 3. Google sometimes returns codes like "4/0AV..." â†’ must decode
    if (code) {
      code = decodeURIComponent(code);
    }

    console.log("Extracted code:", code);

    if (!code) {
      statusEl.innerText = "No code found in URL!";
    } else {
      statusEl.innerText = "Found code, sending to backend...";

      // 4. Send POST request to backend with Authorization header
      fetch("/google_analytics/analytics/oauth2callback/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzU2NjgxMDU4LCJpYXQiOjE3NTY2NzM4NTgsImp0aSI6ImEzOTRhNTZmMzQwMDQ3NTA5YjBmMzdmOWQ4MDBkODRkIiwidXNlcl9pZCI6NX0.n4mthxc4ryw_ulmy95qlxUoFFt1-ZaSWMp8FR0C0uak"
        },
        body: JSON.stringify({ code })
      })
      .then(res => res.json())
      .then(data => {
        console.log("Backend response:", data);
        statusEl.innerText = "Backend response: " + JSON.stringify(data);
      })
      .catch(err => {
        console.error("Error:", err);
        statusEl.innerText = "Error: " + err;
      });
    }
  </script>
</body>
</html>
